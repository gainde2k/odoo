name: Configure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - production
          - staging
          - dev
      action:
        description: 'Configuration action'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply

env:
  ANSIBLE_FORCE_COLOR: 1
  ANSIBLE_HOST_KEY_CHECKING: false

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      droplet-ip: ${{ steps.droplet-info.outputs.ip }}
      has-ip: ${{ steps.droplet-info.outputs.has-ip }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GIT_TOKEN }}

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          environment: ${{ inputs.environment }}
          tf-api-token: ${{ secrets.TF_API_TOKEN }}
          do-token: ${{ secrets.DO_TOKEN }}
          namecom-username: ${{ vars.NAMECOM_USERNAME }}
          namecom-token: ${{ secrets.NAMECOM_TOKEN }}

      - name: Setup Ansible
        uses: ./.github/actions/ansible-setup
        with:
          environment: ${{ inputs.environment }}
          git-token: ${{ secrets.GIT_TOKEN }}

      - name: Get Reserved IP from Terraform
        working-directory: ./terraform
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init -input=false -reconfigure
          RESERVED_IP=$(terraform output -raw active_reserved_ip 2>/dev/null || echo "")
          if [ -n "$RESERVED_IP" ]; then
            echo "reserved-ip=$RESERVED_IP" >> $GITHUB_OUTPUT
            echo "has-reserved-ip=true" >> $GITHUB_OUTPUT
          else
            echo "has-reserved-ip=false" >> $GITHUB_OUTPUT
          fi
        id: reserved-ip-info

      - name: Get Droplet IP
        uses: ./.github/actions/digitalocean
        with:
          environment: ${{ inputs.environment }}
          action: 'get-droplet-ip'
          do-token: ${{ secrets.DO_TOKEN }}
        id: droplet-info

      - name: Check if droplet exists
        if: steps.droplet-info.outputs.has-ip == 'false'
        run: |
          echo "âŒ No droplet found for environment ${{ inputs.environment }}"
          exit 1

      - name: Retrieve SSH Key from Terraform Remote State
        working-directory: ./terraform
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init -input=false -reconfigure

          SSH_KEY=$(terraform output -raw ssh_private_key)

          if [ -z "$SSH_KEY" ]; then
            echo "::error::No SSH key found in Terraform remote state"
            exit 1
          fi

          echo "$SSH_KEY" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key

      - name: Generate Inventory
        run: |
          # Determine which IP to use - prefer reserved IP if available
          if [ "${{ steps.reserved-ip-info.outputs.has-reserved-ip }}" == "true" ]; then
            IP_TO_USE="${{ steps.reserved-ip-info.outputs.reserved-ip }}"
            echo "Using reserved IP: $IP_TO_USE"
          else
            IP_TO_USE="${{ steps.droplet-info.outputs.ip }}"
            echo "Using droplet IP: $IP_TO_USE"
          fi
          
          mkdir -p ansible/inventories/${{ inputs.environment }}
          cat > ansible/inventories/${{ inputs.environment }}/hosts << EOF
          [odoo]
          $IP_TO_USE ansible_user=root

          [odoo:vars]
          ansible_user=root
          ansible_ssh_private_key_file=/tmp/ssh_key
          env=${{ inputs.environment }}
          EOF

      - name: Setup SSH
        run: |
          eval $(ssh-agent -s)
          ssh-add /tmp/ssh_key
          mkdir -p ~/.ssh
          # Use the same IP determination logic
          if [ "${{ steps.reserved-ip-info.outputs.has-reserved-ip }}" == "true" ]; then
            ssh-keyscan -H ${{ steps.reserved-ip-info.outputs.reserved-ip }} >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ steps.droplet-info.outputs.ip }} >> ~/.ssh/known_hosts
          fi

      - name: Create deployment config directory
        run: |
          mkdir -p /tmp/deployment-config

      - name: Copy SSH key and inventory to upload directory
        run: |
          cp /tmp/ssh_key /tmp/deployment-config/ssh_key
          cp -r ansible/inventories/${{ inputs.environment }} /tmp/deployment-config/

      - name: Upload SSH key and inventory
        uses: actions/upload-artifact@v4
        with:
          name: deployment-config-${{ inputs.environment }}
          path: /tmp/deployment-config/

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: setup
    if: needs.setup.outputs.has-ip == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GIT_TOKEN }}

      - name: Setup Ansible
        uses: ./.github/actions/ansible-setup
        with:
          environment: ${{ inputs.environment }}
          git-token: ${{ secrets.GIT_TOKEN }}

      - name: Download deployment config
        uses: actions/download-artifact@v4
        with:
          name: deployment-config-${{ inputs.environment }}
          path: /tmp/deployment-config/

      - name: Setup SSH key permissions and extract IP
        run: |
          # Copy SSH key to the expected location
          cp /tmp/deployment-config/ssh_key /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          chmod 600 /tmp/deployment-config/ssh_key
          
          # Create SSH config
          mkdir -p ~/.ssh
          
          # Extract IP from hosts file
          ip=$(grep -Eo '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' /tmp/deployment-config/${{ inputs.environment }}/hosts | head -1)
          echo "Droplet IP: $ip"
          
          # Add to known hosts
          ssh-keyscan -H $ip >> ~/.ssh/known_hosts

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          # Git Configuration
          GIT_USER: ${{ vars.GIT_USER }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          
          # Database Configuration
          DB_HOST: ${{ vars.DB_HOST }}
          DB_PORT: ${{ vars.DB_PORT }}
          DB_USER: ${{ vars.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ vars.DB_NAME }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          ODOO_DB: ${{ vars.ODOO_DB }}
          ODOO_USERNAME: ${{ vars.ODOO_USERNAME }}
          ODOO_PASSWORD: ${{ secrets.ODOO_PASSWORD }}
          
          # Odoo Server Configuration
          ODOO_WORKERS: ${{ vars.ODOO_WORKERS || '0' }}
          ODOO_LOG_LEVEL: ${{ vars.ODOO_LOG_LEVEL || 'info' }}
          ODOO_MAX_CRON_THREADS: ${{ vars.ODOO_MAX_CRON_THREADS || '2' }}
          ODOO_PROXY_MODE: ${{ vars.ODOO_PROXY_MODE || 'False' }}
          DB_MAXCONN: ${{ vars.DB_MAXCONN || '64' }}
          DB_TEMPLATE: ${{ vars.DB_TEMPLATE || 'template0' }}
          SKIP_MODULE_SETUP: ${{ vars.SKIP_MODULE_SETUP || 'false' }}
          
          # Wave API Configuration
          WAVE_CHECKOUT_API_KEY: ${{ secrets.WAVE_CHECKOUT_API_KEY }}
          WAVE_PAYOUT_API_KEY: ${{ secrets.WAVE_PAYOUT_API_KEY }}
          WAVE_BALANCE_API_KEY: ${{ secrets.WAVE_BALANCE_API_KEY }}
          WAVE_PAYMENT_RECEIVED_SHARED_SECRET: ${{ secrets.WAVE_PAYMENT_RECEIVED_SHARED_SECRET }}
          SERVER_URL: ${{ vars.SERVER_URL }}
          
          # Meta/WhatsApp API Configuration
          META_BUNSINESS_MANAGER_ID: ${{ vars.META_BUNSINESS_MANAGER_ID || '1620644888498053' }}
          META_APP_ID: ${{ vars.META_APP_ID || '1277638880203763' }}
          META_APP_SECRET: ${{ secrets.META_APP_SECRET }}
          META_BASE_API_URL: ${{ vars.META_BASE_API_URL || 'https://graph.facebook.com/v22.0/' }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
          META_WEBHOOK_URL: ${{ vars.META_WEBHOOK_URL }}
          META_VERIFY_TOKEN: ${{ vars.META_VERIFY_TOKEN }}
          WHATSAPP_PHONE_NUMBER: ${{ vars.WHATSAPP_PHONE_NUMBER }}
          WHATSAPP_PHONE_NUMBER_ID: ${{ vars.WHATSAPP_PHONE_NUMBER_ID }}
          WHATSAPP_BUSINESS_ACCOUNT_ID: ${{ vars.WHATSAPP_BUSINESS_ACCOUNT_ID }}
          WHATSAPP_CATALOG_ID: ${{ vars.WHATSAPP_CATALOG_ID || '' }}
          WHATSAPP_FLOW_PRIVATE_KEY: ${{ secrets.WHATSAPP_FLOW_PRIVATE_KEY }}
          
          # AI/Agent Configuration
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DULAYNI_API_KEY: ${{ secrets.DULAYNI_API_KEY }}
          AGENTIC_API_KEY: ${{ secrets.AGENTIC_API_KEY }}
          AGENTIC_BASE_URL: ${{ vars.AGENTIC_BASE_URL || 'https://openrouter.ai/api/v1' }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DEEPSEEK_OPENROUTER_API_KEY: ${{ secrets.DEEPSEEK_OPENROUTER_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Company Defaults
          DEFAULT_ADMIN_PHONE: ${{ vars.DEFAULT_ADMIN_PHONE }}
          DEFAULT_COMPANY_EMAIL: ${{ vars.DEFAULT_COMPANY_EMAIL }}
          DEFAULT_COMPANY_PHONE: ${{ vars.DEFAULT_COMPANY_PHONE }}
        run: |
          # Update the inventory to use the correct SSH key path
          cp /tmp/deployment-config/${{ inputs.environment }}/hosts /tmp/deployment-config/${{ inputs.environment }}/hosts.bak
          sed -i 's|ansible_ssh_private_key_file=/tmp/ssh_key|ansible_ssh_private_key_file=/tmp/deployment-config/ssh_key|g' /tmp/deployment-config/${{ inputs.environment }}/hosts
          
          ansible-playbook \
            -i /tmp/deployment-config/${{ inputs.environment }}/hosts \
            playbooks/deploy-odoo.yml \
            --private-key /tmp/deployment-config/ssh_key \
            --extra-vars "ansible_ssh_retries=5 ansible_ssh_timeout=30 \
                          github_token=$GIT_TOKEN \
                          github_user=$GIT_USER \
                          openai_api_key=$OPENAI_API_KEY \
                          db_host=$DB_HOST \
                          db_port=$DB_PORT \
                          db_user=$DB_USER \
                          db_password=$DB_PASSWORD \
                          db_name=$DB_NAME \
                          pgpassword=$PGPASSWORD \
                          odoo_db=$ODOO_DB \
                          odoo_username=$ODOO_USERNAME \
                          odoo_password=$ODOO_PASSWORD \
                          odoo_workers=$ODOO_WORKERS \
                          odoo_log_level=$ODOO_LOG_LEVEL \
                          odoo_max_cron_threads=$ODOO_MAX_CRON_THREADS \
                          odoo_proxy_mode=$ODOO_PROXY_MODE \
                          db_maxconn=$DB_MAXCONN \
                          db_template=$DB_TEMPLATE \
                          skip_module_setup=$SKIP_MODULE_SETUP \
                          wave_checkout_api_key=$WAVE_CHECKOUT_API_KEY \
                          wave_payout_api_key=$WAVE_PAYOUT_API_KEY \
                          wave_balance_api_key=$WAVE_BALANCE_API_KEY \
                          wave_payment_received_shared_secret=$WAVE_PAYMENT_RECEIVED_SHARED_SECRET \
                          server_url=$SERVER_URL \
                          meta_business_manager_id=$META_BUNSINESS_MANAGER_ID \
                          meta_app_id=$META_APP_ID \
                          meta_app_secret=$META_APP_SECRET \
                          meta_base_api_url=$META_BASE_API_URL \
                          meta_access_token=$META_ACCESS_TOKEN \
                          meta_webhook_url=$META_WEBHOOK_URL \
                          meta_verify_token=$META_VERIFY_TOKEN \
                          whatsapp_phone_number=$WHATSAPP_PHONE_NUMBER \
                          whatsapp_phone_number_id=$WHATSAPP_PHONE_NUMBER_ID \
                          whatsapp_business_account_id=$WHATSAPP_BUSINESS_ACCOUNT_ID \
                          whatsapp_catalog_id=$WHATSAPP_CATALOG_ID \
                          whatsapp_flow_private_key=$WHATSAPP_FLOW_PRIVATE_KEY \
                          dulayni_api_key=$DULAYNI_API_KEY \
                          agentic_api_key=$AGENTIC_API_KEY \
                          agentic_base_url=$AGENTIC_BASE_URL \
                          claude_api_key=$CLAUDE_API_KEY \
                          openrouter_api_key=$OPENROUTER_API_KEY \
                          deepseek_openrouter_api_key=$DEEPSEEK_OPENROUTER_API_KEY \
                          gemini_api_key=$GEMINI_API_KEY \
                          default_admin_phone=$DEFAULT_ADMIN_PHONE \
                          default_company_email=$DEFAULT_COMPANY_EMAIL \
                          default_company_phone=$DEFAULT_COMPANY_PHONE"

      - name: Show container logs on failure
        if: failure()
        run: |
          ip=$(grep -Eo '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' /tmp/deployment-config/${{ inputs.environment }}/hosts | head -1)
          ssh -i /tmp/deployment-config/ssh_key -o StrictHostKeyChecking=no root@$ip "cd /home/odoo/${{ inputs.environment }} && docker-compose logs"