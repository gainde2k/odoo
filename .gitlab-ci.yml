stages:
  - .pre
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest
  EXTERNAL_REGISTRY: $EXTERNAL_GITLAB_REGISTRY
  EXTERNAL_PATH: gainde2k/helm/odoo
  EXTERNAL_IMAGE_TAG: $EXTERNAL_GITLAB_REGISTRY/$EXTERNAL_PATH:latest
  GIT_SUBMODULE_STRATEGY: none
  CI_SERVER_URL: "https://gitlab.kilifa.fr"

cache:
  key: docker
  paths:
    - .cache/docker

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# ------------------------------
# DEBUG STAGE
# ------------------------------
debug_ssh:
  stage: .pre
  tags:
    - dev
  image: alpine:latest
  before_script:
    - apk add --no-cache git openssh-client curl
  script:
    - echo "=== Environment Variables Check ==="
    - env | grep -i ssh || echo "No SSH variables found"
    - env | grep -i ci | head -5
    - echo "SSH_PRIVATE_KEY_BASE64 variable exists - $(if [ -n \"$SSH_PRIVATE_KEY_BASE64\" ]; then echo \"YES (length - ${#SSH_PRIVATE_KEY_BASE64})\"; else echo \"NO\"; fi)"
    - echo "=== Setting up SSH ==="
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | tr -d '\r' | ssh-add -
    - echo "Loaded SSH keys:"
    - ssh-add -l || echo "No keys loaded or error listing keys"
    - echo "=== SSH Configuration ==="
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p 2222 gitlab.kilifa.fr >> ~/.ssh/known_hosts
    - ssh-keyscan -p 22 gitlab.kilifa.fr >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - |
      cat > ~/.ssh/config << 'EOF'
      Host gitlab.kilifa.fr
          Port 2222
          User git
          StrictHostKeyChecking yes
      EOF
    - chmod 600 ~/.ssh/config
    - echo "=== Testing SSH Connection ==="
    - ssh -T -p 2222 -o ConnectTimeout=10 git@gitlab.kilifa.fr && echo "SSH connection successful" || echo "SSH connection failed - but this might be normal for GitLab"
    - echo "=== Testing Git Operations ==="
    - git clone https://gitlab.kilifa.fr/gainde2k/odoo.git /tmp/test-repo
    - cd /tmp/test-repo
    - git config --global url."ssh://git@gitlab.kilifa.fr:2222/".insteadOf "https://gitlab.kilifa.fr/"
    - echo "Testing submodule update..."
    - git submodule update --init --recursive
    - echo "Submodule test completed with exit code - $?"
    - echo "=== Directory Structure ==="
    - ls -la /tmp/test-repo/addons/ || echo "Could not list addons directory"
    - echo "=== Git Submodule Status ==="
    - git submodule status --recursive || echo "Could not get submodule status"
  only:
    - main
    - develop
  allow_failure: true

# ------------------------------
# BUILD STAGE
# ------------------------------
build:
  stage: build
  tags:
    - dev
  image: docker:latest
  before_script:
    - apk add --no-cache git openssh-client
    - eval $(ssh-agent -s)
    - echo "Loading SSH key (length-${#SSH_PRIVATE_KEY_BASE64})"
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | tr -d '\r' | ssh-add -
    - echo "Loaded SSH keys:"
    - ssh-add -l
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p 2222 gitlab.kilifa.fr >> ~/.ssh/known_hosts
    - ssh-keyscan -p 22 gitlab.kilifa.fr >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - |
      cat > ~/.ssh/config << 'EOF'
      Host gitlab.kilifa.fr
          Port 2222
          User git
          StrictHostKeyChecking yes
      EOF
    - chmod 600 ~/.ssh/config
    - git config --global url."ssh://git@gitlab.kilifa.fr:2222/".insteadOf "https://gitlab.kilifa.fr/"
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "=== Listing all submodules ==="
    - git submodule status --recursive
    - echo "=== Checking addons directory structure ==="
    - ls -la ./addons || echo "WARNING - addons directory not found"
    - ls -la ./addons/gainde || echo "WARNING - gainde submodule not found"
    - find ./addons -maxdepth 3 -type d 2>/dev/null || echo "Could not list addons structure"
    - echo "=== Starting Docker build ==="
    - |
      docker build \
        --build-arg OPENAI_API_KEY="$OPENAI_API_KEY" \
        --build-arg DB_HOST="$DB_HOST" \
        --build-arg DB_PORT="$DB_PORT" \
        --build-arg DB_USER="$DB_USER" \
        --build-arg DB_PASSWORD="$DB_PASSWORD" \
        --build-arg DB_NAME="$DB_NAME" \
        --build-arg PGPASSWORD="$PGPASSWORD" \
        --build-arg ODOO_DB="$ODOO_DB" \
        --build-arg ODOO_USERNAME="$ODOO_USERNAME" \
        --build-arg ADMIN_PASSWD="$ADMIN_PASSWD" \
        --build-arg PG_URI="$PG_URI" \
        --build-arg WAVE_CHECKOUT_API_KEY="$WAVE_CHECKOUT_API_KEY" \
        --build-arg WAVE_PAYOUT_API_KEY="$WAVE_PAYOUT_API_KEY" \
        --build-arg WAVE_BALANCE_API_KEY="$WAVE_BALANCE_API_KEY" \
        --build-arg WAVE_PAYMENT_RECEIVED_SHARED_SECRET="$WAVE_PAYMENT_RECEIVED_SHARED_SECRET" \
        --build-arg SERVER_URL="$SERVER_URL" \
        --build-arg META_VERIFY_TOKEN="$META_VERIFY_TOKEN" \
        --build-arg META_ACCESS_TOKEN="$META_ACCESS_TOKEN" \
        --build-arg WHATSAPP_PHONE_NUMBER="$WHATSAPP_PHONE_NUMBER" \
        --build-arg WHATSAPP_PHONE_NUMBER_ID="$WHATSAPP_PHONE_NUMBER_ID" \
        --build-arg WHATSAPP_BUSINESS_ACCOUNT_ID="$WHATSAPP_BUSINESS_ACCOUNT_ID" \
        --build-arg META_BASE_API_URL="$META_BASE_API_URL" \
        --build-arg WHATSAPP_FLOW_PRIVATE_KEY="$WHATSAPP_FLOW_PRIVATE_KEY" \
        --build-arg DULAYNI_API_KEY="$DULAYNI_API_KEY" \
        --build-arg AGENTIC_API_KEY="$AGENTIC_API_KEY" \
        --build-arg AGENTIC_BASE_URL="$AGENTIC_BASE_URL" \
        --build-arg DB_URI="$DB_URI" \
        --build-arg DEFAULT_ADMIN_PHONE="$DEFAULT_ADMIN_PHONE" \
        --build-arg DEFAULT_COMPANY_EMAIL="$DEFAULT_COMPANY_EMAIL" \
        --build-arg DEFAULT_COMPANY_PHONE="$DEFAULT_COMPANY_PHONE" \
        -t $LATEST_TAG .
    - docker push $LATEST_TAG
    - echo "IMAGE_TAG=latest" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - main
    - develop
    - tags

# ------------------------------
# TEST STAGE
# ------------------------------
test:
  stage: test
  tags:
    - dev
  image: $LATEST_TAG
  services:
    - postgres:13
  variables:
    POSTGRES_DB: $DB_NAME
    POSTGRES_USER: $DB_USER
    POSTGRES_PASSWORD: $DB_PASSWORD
  before_script:
    - apt-get update && apt-get install -y postgresql-client
    - |
      for i in {1..30}; do
        pg_isready -h postgres -U $DB_USER && break
        echo "Waiting for database... ($i/30)"
        sleep 2
      done
  script:
    - echo "Testing Odoo container..."
    - timeout 30s docker run --rm $LATEST_TAG odoo --help || echo "Odoo help command completed"
    - echo "Container test passed"
  dependencies:
    - build
  only:
    - main
    - develop

# ------------------------------
# DEPLOY STAGE
# ------------------------------
deploy:
  stage: deploy
  tags:
    - dev
  image: docker:latest
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker login -u $EXTERNAL_GITLAB_ADMIN -p $EXTERNAL_GITLAB_TOKEN $EXTERNAL_GITLAB_REGISTRY
  script:
    - echo "Pulling tested image from internal registry"
    - docker pull $LATEST_TAG
    - echo "Tagging image for external registry"
    - docker tag $LATEST_TAG $EXTERNAL_IMAGE_TAG
    - echo "Pushing image to external registry"
    - docker push $EXTERNAL_IMAGE_TAG
    - echo "Deploy finished successfully"
  environment:
    name: production
    url: https://kilifa.fr
  dependencies:
    - build
    - test
  only:
    - main

# ------------------------------
# DOCKERFILE LINTING
# ------------------------------
dockerfile_lint:
  stage: test
  image: hadolint/hadolint:latest
  script:
    - hadolint Dockerfile
  allow_failure: true

# ------------------------------
# SECURITY TEMPLATES
# ------------------------------
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
