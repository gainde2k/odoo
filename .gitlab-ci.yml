stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest
  COMMIT_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

cache:
  key: docker
  paths:
    - .cache/docker

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - |
      docker build \
        --build-arg OPENAI_API_KEY="$OPENAI_API_KEY" \
        --build-arg DB_HOST="$DB_HOST" \
        --build-arg DB_PORT="$DB_PORT" \
        --build-arg DB_USER="$DB_USER" \
        --build-arg DB_PASSWORD="$DB_PASSWORD" \
        --build-arg DB_NAME="$DB_NAME" \
        --build-arg PGPASSWORD="$PGPASSWORD" \
        --build-arg ODOO_DB="$ODOO_DB" \
        --build-arg ODOO_USERNAME="$ODOO_USERNAME" \
        --build-arg ODOO_PASSWORD="$ODOO_PASSWORD" \
        --build-arg PG_URI="$PG_URI" \
        --build-arg WAVE_CHECKOUT_API_KEY="$WAVE_CHECKOUT_API_KEY" \
        --build-arg WAVE_PAYOUT_API_KEY="$WAVE_PAYOUT_API_KEY" \
        --build-arg WAVE_BALANCE_API_KEY="$WAVE_BALANCE_API_KEY" \
        --build-arg WAVE_PAYMENT_RECEIVED_SHARED_SECRET="$WAVE_PAYMENT_RECEIVED_SHARED_SECRET" \
        --build-arg SERVER_URL="$SERVER_URL" \
        --build-arg META_VERIFY_TOKEN="$META_VERIFY_TOKEN" \
        --build-arg META_ACCESS_TOKEN="$META_ACCESS_TOKEN" \
        --build-arg WHATSAPP_PHONE_NUMBER="$WHATSAPP_PHONE_NUMBER" \
        --build-arg WHATSAPP_PHONE_NUMBER_ID="$WHATSAPP_PHONE_NUMBER_ID" \
        --build-arg WHATSAPP_BUSINESS_ACCOUNT_ID="$WHATSAPP_BUSINESS_ACCOUNT_ID" \
        --build-arg META_BASE_API_URL="$META_BASE_API_URL" \
        --build-arg WHATSAPP_FLOW_PRIVATE_KEY="$WHATSAPP_FLOW_PRIVATE_KEY" \
        --build-arg DULAYNI_API_KEY="$DULAYNI_API_KEY" \
        --build-arg AGENTIC_API_KEY="$AGENTIC_API_KEY" \
        --build-arg AGENTIC_BASE_URL="$AGENTIC_BASE_URL" \
        --build-arg DB_URI="$DB_URI" \
        --build-arg DEFAULT_ADMIN_PHONE="$DEFAULT_ADMIN_PHONE" \
        --build-arg DEFAULT_COMPANY_EMAIL="$DEFAULT_COMPANY_EMAIL" \
        --build-arg DEFAULT_COMPANY_PHONE="$DEFAULT_COMPANY_PHONE" \
        -t $LATEST_TAG \
        -t $COMMIT_TAG \
        .
    - docker push $LATEST_TAG
    - docker push $COMMIT_TAG
  artifacts:
    reports:
      dotenv: build.env
  after_script:
    - echo "IMAGE_TAG=$COMMIT_TAG" >> build.env
  only:
    - main
    - develop
    - tags

test:
  stage: test
  image: $LATEST_TAG
  services:
    - postgres:13
  variables:
    POSTGRES_DB: $DB_NAME
    POSTGRES_USER: $DB_USER
    POSTGRES_PASSWORD: $DB_PASSWORD
  before_script:
    - apt-get update && apt-get install -y postgresql-client
    - |
      for i in {1..30}; do
        pg_isready -h postgres -U $DB_USER && break
        echo "Waiting for database... ($i/30)"
        sleep 2
      done
  script:
    - echo "Testing Odoo container..."
    - timeout 30s docker run --rm $LATEST_TAG odoo --help || echo "Odoo help command completed"
    - echo "Container test passed"
  dependencies:
    - build
  only:
    - main
    - develop

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying image $COMMIT_TAG to production"
    - echo "Deployment would happen here - update with your actual deployment process"
  environment:
    name: production
    url: https://your-odoo-domain.com
  dependencies:
    - build
  only:
    - main
  when: manual

sast:
  stage: test
  include:
    - template: Security/SAST.gitlab-ci.yml

container_scanning:
  stage: test
  include:
    - template: Security/Container-Scanning.gitlab-ci.yml

dockerfile_lint:
  stage: test
  image: hadolint/hadolint:latest
  script:
    - hadolint Dockerfile
  allow_failure: true