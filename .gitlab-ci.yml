stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest
  EXTERNAL_REGISTRY: $KILIFA_GITLAB_REGISTRY
  EXTERNAL_IMAGE_TAG: $KILIFA_GITLAB_REGISTRY/$CI_PROJECT_PATH:latest
  GIT_SUBMODULE_STRATEGY: none

cache:
  key: docker
  paths:
    - .cache/docker

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache git openssh-client
    - echo "=== Setting up SSH for submodules ==="
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "=== Configuring git to use SSH instead of HTTPS ==="
    - git config --global url."git@gitlab.com:".insteadOf "https://gitlab.com/"
    - echo "=== Checking .gitmodules before sync ==="
    - cat .gitmodules
    - echo "=== SSH setup complete ==="
    - echo "=== Cloning submodules ==="
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "=== Listing all submodules ==="
    - git submodule status --recursive
    - echo ""
    - echo "=== Checking submodule paths ==="
    - echo "Contents of ./addons directory:"
    - ls -la ./addons/ || echo "WARNING - addons directory not found"
    - echo ""
    - echo "Contents of ./addons/gainde:"
    - ls -la ./addons/gainde || echo "WARNING - gainde submodule not found"
    - echo ""
    - echo "Tree structure of addons (first 3 levels):"
    - find ./addons -maxdepth 3 -type d 2>/dev/null || echo "Could not list addons structure"
    - echo ""
    - echo "=== Starting Docker build ==="
    - |
      docker build \
        --build-arg OPENAI_API_KEY="$OPENAI_API_KEY" \
        --build-arg DB_HOST="$DB_HOST" \
        --build-arg DB_PORT="$DB_PORT" \
        --build-arg DB_USER="$DB_USER" \
        --build-arg DB_PASSWORD="$DB_PASSWORD" \
        --build-arg DB_NAME="$DB_NAME" \
        --build-arg PGPASSWORD="$PGPASSWORD" \
        --build-arg ODOO_DB="$ODOO_DB" \
        --build-arg ODOO_USERNAME="$ODOO_USERNAME" \
        --build-arg ODOO_PASSWORD="$ODOO_PASSWORD" \
        --build-arg PG_URI="$PG_URI" \
        --build-arg WAVE_CHECKOUT_API_KEY="$WAVE_CHECKOUT_API_KEY" \
        --build-arg WAVE_PAYOUT_API_KEY="$WAVE_PAYOUT_API_KEY" \
        --build-arg WAVE_BALANCE_API_KEY="$WAVE_BALANCE_API_KEY" \
        --build-arg WAVE_PAYMENT_RECEIVED_SHARED_SECRET="$WAVE_PAYMENT_RECEIVED_SHARED_SECRET" \
        --build-arg SERVER_URL="$SERVER_URL" \
        --build-arg META_VERIFY_TOKEN="$META_VERIFY_TOKEN" \
        --build-arg META_ACCESS_TOKEN="$META_ACCESS_TOKEN" \
        --build-arg WHATSAPP_PHONE_NUMBER="$WHATSAPP_PHONE_NUMBER" \
        --build-arg WHATSAPP_PHONE_NUMBER_ID="$WHATSAPP_PHONE_NUMBER_ID" \
        --build-arg WHATSAPP_BUSINESS_ACCOUNT_ID="$WHATSAPP_BUSINESS_ACCOUNT_ID" \
        --build-arg META_BASE_API_URL="$META_BASE_API_URL" \
        --build-arg WHATSAPP_FLOW_PRIVATE_KEY="$WHATSAPP_FLOW_PRIVATE_KEY" \
        --build-arg DULAYNI_API_KEY="$DULAYNI_API_KEY" \
        --build-arg AGENTIC_API_KEY="$AGENTIC_API_KEY" \
        --build-arg AGENTIC_BASE_URL="$AGENTIC_BASE_URL" \
        --build-arg DB_URI="$DB_URI" \
        --build-arg DEFAULT_ADMIN_PHONE="$DEFAULT_ADMIN_PHONE" \
        --build-arg DEFAULT_COMPANY_EMAIL="$DEFAULT_COMPANY_EMAIL" \
        --build-arg DEFAULT_COMPANY_PHONE="$DEFAULT_COMPANY_PHONE" \
        -t $LATEST_TAG \
        .
    - docker push $LATEST_TAG
  artifacts:
    reports:
      dotenv: build.env
  after_script:
    - echo "IMAGE_TAG=latest" >> build.env
  only:
    - main
    - develop
    - tags

test:
  stage: test
  image: $LATEST_TAG
  services:
    - postgres:13
  variables:
    POSTGRES_DB: $DB_NAME
    POSTGRES_USER: $DB_USER
    POSTGRES_PASSWORD: $DB_PASSWORD
  before_script:
    - apt-get update && apt-get install -y postgresql-client
    - |
      for i in {1..30}; do
        pg_isready -h postgres -U $DB_USER && break
        echo "Waiting for database... ($i/30)"
        sleep 2
      done
  script:
    - echo "Testing Odoo container..."
    - timeout 30s docker run --rm $LATEST_TAG odoo --help || echo "Odoo help command completed"
    - echo "Container test passed"
  dependencies:
    - build
  only:
    - main
    - develop

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker login -u $KILIFA_GITLAB_USER -p $KILIFA_GITLAB_TOKEN $KILIFA_GITLAB_REGISTRY
  script:
    - echo "Pulling image from internal registry"
    - docker pull $LATEST_TAG
    - echo "Tagging image for external registry"
    - docker tag $LATEST_TAG $EXTERNAL_IMAGE_TAG
    - echo "Pushing image to external registry:$KILIFA_GITLAB_REGISTRY"
    - docker push $EXTERNAL_IMAGE_TAG
    - echo "Successfully pushed image to external registry"
    - echo "Deploying latest image to production environment"
  environment:
    name: production
    url: https://kilifa.fr
  dependencies:
    - build
  only:
    - main

dockerfile_lint:
  stage: test
  image: hadolint/hadolint:latest
  script:
    - hadolint Dockerfile
  allow_failure: true

# Include GitLab security templates at the top level
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
